<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Second Brain - Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card h3 {
            color: #5a67d8;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .stat {
            font-size: 2rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #718096;
            font-size: 0.9rem;
        }

        .search-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .search-form {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #5a67d8;
        }

        .btn {
            background: #5a67d8;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s ease;
        }

        .btn:hover {
            background: #4c51bf;
        }

        .visualization-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .results-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .memory-item {
            border-left: 4px solid #5a67d8;
            padding: 15px;
            margin-bottom: 15px;
            background: #f7fafc;
            border-radius: 0 8px 8px 0;
        }

        .memory-content {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .memory-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #718096;
        }

        .importance-badge {
            background: #5a67d8;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .tag {
            background: #bee3f8;
            color: #2b6cb0;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-right: 5px;
        }

        #memory-network {
            width: 100%;
            height: 400px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .node {
            cursor: pointer;
        }

        .link {
            stroke: #999;
            stroke-opacity: 0.6;
        }

        .node text {
            pointer-events: none;
            font: 10px sans-serif;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† Second Brain Dashboard</h1>
            <p>PostgreSQL + pgvector Edition v2.4.2</p>
        </div>

        <!-- Statistics Cards -->
        <div class="dashboard-grid">
            <div class="card">
                <h3>üìö Total Memories</h3>
                <div class="stat" id="total-memories">-</div>
                <div class="stat-label">Stored in database</div>
            </div>
            <div class="card">
                <h3>üîç Search Performance</h3>
                <div class="stat" id="avg-search-time">-</div>
                <div class="stat-label">Average response time</div>
            </div>
            <div class="card">
                <h3>‚≠ê High Importance</h3>
                <div class="stat" id="high-importance">-</div>
                <div class="stat-label">Memories with importance > 7</div>
            </div>
            <div class="card">
                <h3>üè∑Ô∏è Unique Tags</h3>
                <div class="stat" id="unique-tags">-</div>
                <div class="stat-label">Different categories</div>
            </div>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <h3>üîç Search Memories</h3>
            <div class="search-form">
                <input type="text" class="search-input" id="search-query" placeholder="Search your memories...">
                <button class="btn" onclick="searchMemories()">Search</button>
            </div>
            <div>
                <label>Minimum Importance: </label>
                <input type="range" id="importance-slider" min="0" max="10" step="0.1" value="0">
                <span id="importance-value">0</span>
            </div>
        </div>

        <!-- Memory Network Visualization -->
        <div class="visualization-container">
            <h3>üï∏Ô∏è Memory Network</h3>
            <svg id="memory-network"></svg>
        </div>

        <!-- Search Results -->
        <div class="results-container">
            <h3>üìã Recent Memories</h3>
            <div id="results-content">
                <div class="loading">Loading memories...</div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = '';
        const AUTH_TOKEN = localStorage.getItem('auth_token') || 'demo-token';

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            setupEventListeners();
            initializeVisualization();
        });

        function setupEventListeners() {
            // Search on Enter key
            document.getElementById('search-query').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchMemories();
                }
            });

            // Importance slider
            document.getElementById('importance-slider').addEventListener('input', function(e) {
                document.getElementById('importance-value').textContent = e.target.value;
            });
        }

        async function loadDashboardData() {
            try {
                // Load health data
                const healthResponse = await fetch('/health');
                const healthData = await healthResponse.json();
                
                if (healthData.status === 'healthy') {
                    document.getElementById('total-memories').textContent = healthData.memory_count;
                }

                // Load recent memories
                const memoriesResponse = await fetch('/memories?limit=10', {
                    headers: {
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    }
                });
                
                if (memoriesResponse.ok) {
                    const memories = await memoriesResponse.json();
                    displayMemories(memories);
                    updateStatistics(memories);
                    updateNetworkVisualization(memories);
                } else {
                    showError('Failed to load memories. Please check your authentication token.');
                }

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showError('Failed to connect to the API.');
            }
        }

        function displayMemories(memories) {
            const container = document.getElementById('results-content');
            
            if (memories.length === 0) {
                container.innerHTML = '<div class="loading">No memories found.</div>';
                return;
            }

            const html = memories.map(memory => `
                <div class="memory-item">
                    <div class="memory-content">${escapeHtml(memory.content)}</div>
                    <div class="memory-meta">
                        <div>
                            ${memory.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
                        </div>
                        <div>
                            <span class="importance-badge">${memory.importance}/10</span>
                            <span>${new Date(memory.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function updateStatistics(memories) {
            // Calculate high importance memories
            const highImportance = memories.filter(m => m.importance > 7).length;
            document.getElementById('high-importance').textContent = highImportance;

            // Calculate unique tags
            const allTags = memories.flatMap(m => m.tags);
            const uniqueTags = new Set(allTags).size;
            document.getElementById('unique-tags').textContent = uniqueTags;

            // Mock search time
            document.getElementById('avg-search-time').textContent = '45ms';
        }

        async function searchMemories() {
            const query = document.getElementById('search-query').value.trim();
            const importanceMin = parseFloat(document.getElementById('importance-slider').value);

            if (!query) {
                alert('Please enter a search query');
                return;
            }

            try {
                document.getElementById('results-content').innerHTML = '<div class="loading">Searching...</div>';

                const searchRequest = {
                    query: query,
                    limit: 20,
                    threshold: 0.7,
                    importance_min: importanceMin > 0 ? importanceMin : null
                };

                const response = await fetch('/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify(searchRequest)
                });

                if (response.ok) {
                    const results = await response.json();
                    displaySearchResults(results);
                } else {
                    showError('Search failed. Please try again.');
                }

            } catch (error) {
                console.error('Search error:', error);
                showError('Search failed due to network error.');
            }
        }

        function displaySearchResults(results) {
            const container = document.getElementById('results-content');
            
            if (results.length === 0) {
                container.innerHTML = '<div class="loading">No results found for your search.</div>';
                return;
            }

            const html = results.map(result => `
                <div class="memory-item">
                    <div class="memory-content">${escapeHtml(result.memory.content)}</div>
                    <div class="memory-meta">
                        <div>
                            ${result.memory.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
                            <span style="background: #ffd700; color: #333; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem;">
                                ${(result.similarity * 100).toFixed(1)}% match
                            </span>
                        </div>
                        <div>
                            <span class="importance-badge">${result.memory.importance}/10</span>
                            <span>Rank #${result.rank}</span>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function initializeVisualization() {
            const svg = d3.select("#memory-network");
            const width = 800;
            const height = 400;
            
            svg.attr("width", width).attr("height", height);

            // Create simulation
            const simulation = d3.forceSimulation()
                .force("link", d3.forceLink().id(d => d.id))
                .force("charge", d3.forceManyBody().strength(-300))
                .force("center", d3.forceCenter(width / 2, height / 2));

            // Add loading text
            svg.append("text")
                .attr("x", width / 2)
                .attr("y", height / 2)
                .attr("text-anchor", "middle")
                .attr("fill", "#718096")
                .text("Memory network will appear here after loading memories");
        }

        function updateNetworkVisualization(memories) {
            const svg = d3.select("#memory-network");
            svg.selectAll("*").remove(); // Clear existing content

            if (memories.length === 0) return;

            const width = 800;
            const height = 400;

            // Create nodes and links based on tag relationships
            const nodes = memories.map(memory => ({
                id: memory.id,
                content: memory.content.substring(0, 30) + "...",
                importance: memory.importance,
                tags: memory.tags
            }));

            const links = [];
            // Create links between memories that share tags
            for (let i = 0; i < nodes.length; i++) {
                for (let j = i + 1; j < nodes.length; j++) {
                    const sharedTags = nodes[i].tags.filter(tag => nodes[j].tags.includes(tag));
                    if (sharedTags.length > 0) {
                        links.push({
                            source: nodes[i].id,
                            target: nodes[j].id,
                            strength: sharedTags.length
                        });
                    }
                }
            }

            const simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id))
                .force("charge", d3.forceManyBody().strength(-300))
                .force("center", d3.forceCenter(width / 2, height / 2));

            const link = svg.append("g")
                .selectAll("line")
                .data(links)
                .enter().append("line")
                .attr("class", "link")
                .attr("stroke-width", d => Math.sqrt(d.strength) * 2);

            const node = svg.append("g")
                .selectAll("circle")
                .data(nodes)
                .enter().append("circle")
                .attr("class", "node")
                .attr("r", d => 5 + d.importance)
                .attr("fill", d => d3.interpolateViridis(d.importance / 10))
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            const label = svg.append("g")
                .selectAll("text")
                .data(nodes)
                .enter().append("text")
                .text(d => d.content)
                .attr("font-size", "10px")
                .attr("dx", 15)
                .attr("dy", 4);

            node.append("title")
                .text(d => `${d.content}\nImportance: ${d.importance}\nTags: ${d.tags.join(', ')}`);

            simulation
                .on("tick", () => {
                    link
                        .attr("x1", d => d.source.x)
                        .attr("y1", d => d.source.y)
                        .attr("x2", d => d.target.x)
                        .attr("y2", d => d.target.y);

                    node
                        .attr("cx", d => d.x)
                        .attr("cy", d => d.y);

                    label
                        .attr("x", d => d.x)
                        .attr("y", d => d.y);
                });

            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        }

        function showError(message) {
            const container = document.getElementById('results-content');
            container.innerHTML = `<div class="error">${escapeHtml(message)}</div>`;
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Set default auth token if not set
        if (!localStorage.getItem('auth_token')) {
            localStorage.setItem('auth_token', 'demo-token');
        }
    </script>
</body>
</html> 