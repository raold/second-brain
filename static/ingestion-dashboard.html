<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Ingestion Dashboard - Second Brain v2.8.3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e1a;
            color: #e0e0e0;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 100%);
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-bottom: 2px solid #4a5568;
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: #a0aec0;
            font-size: 1.1rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 2rem;
        }

        .card {
            background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 100%);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #4a5568;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border-color: #667eea;
        }

        .card h2 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: #e2e8f0;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            color: #a0aec0;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .upload-zone {
            border: 2px dashed #4a5568;
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: rgba(26, 31, 46, 0.5);
        }

        .upload-zone:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .upload-zone.drag-over {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.2);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            text-decoration: none;
            margin: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
        }

        .file-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .file-item {
            background: rgba(26, 31, 46, 0.5);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #4a5568;
        }

        .file-item:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .file-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-right: 1rem;
        }

        .pdf-icon { background: #dc2626; }
        .doc-icon { background: #2563eb; }
        .img-icon { background: #10b981; }
        .sheet-icon { background: #f59e0b; }
        .txt-icon { background: #8b5cf6; }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #4a5568;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-pending { background: #374151; color: #9ca3af; }
        .status-processing { background: #1e3a8a; color: #60a5fa; }
        .status-completed { background: #14532d; color: #4ade80; }
        .status-failed { background: #7f1d1d; color: #f87171; }

        .google-drive-section {
            margin-top: 3rem;
            padding: 2rem;
            background: linear-gradient(135deg, #1a1f2e 0%, #2d3748 100%);
            border-radius: 12px;
            border: 1px solid #4a5568;
        }

        .drive-files {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .drive-file {
            background: rgba(26, 31, 46, 0.5);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #4a5568;
        }

        .drive-file:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .drive-file.selected {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.2);
        }

        #fileInput {
            display: none;
        }

        .loader {
            border: 3px solid #4a5568;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #dc2626;
            color: #f87171;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .success-message {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid #10b981;
            color: #4ade80;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìÅ File Ingestion Dashboard</h1>
            <p class="subtitle">Second Brain v2.8.3 - Universal Document Processing</p>
        </header>

        <div class="dashboard-grid">
            <div class="card">
                <h2>üìä Ingestion Stats</h2>
                <div class="stat-value" id="totalProcessed">0</div>
                <div class="stat-label">Total Files Processed</div>
            </div>
            <div class="card">
                <h2>‚è≥ Active Jobs</h2>
                <div class="stat-value" id="activeJobs">0</div>
                <div class="stat-label">Currently Processing</div>
            </div>
            <div class="card">
                <h2>‚úÖ Success Rate</h2>
                <div class="stat-value" id="successRate">100%</div>
                <div class="stat-label">Last 24 Hours</div>
            </div>
            <div class="card">
                <h2>üß† Memories Created</h2>
                <div class="stat-value" id="memoriesCreated">0</div>
                <div class="stat-label">From Ingested Files</div>
            </div>
        </div>

        <div class="card">
            <h2>üì§ Upload Files</h2>
            <div class="upload-zone" id="uploadZone">
                <p style="font-size: 3rem; margin-bottom: 1rem;">üìÅ</p>
                <p style="font-size: 1.2rem; margin-bottom: 1rem;">Drag & Drop files here</p>
                <p style="color: #a0aec0; margin-bottom: 1rem;">or</p>
                <button class="btn" onclick="document.getElementById('fileInput').click()">Browse Files</button>
                <input type="file" id="fileInput" multiple accept=".pdf,.docx,.doc,.txt,.md,.html,.jpg,.jpeg,.png,.gif,.bmp,.tiff,.xlsx,.xls,.csv">
                <p style="color: #718096; font-size: 0.9rem; margin-top: 1rem;">
                    Supported: PDF, DOCX, TXT, MD, HTML, Images (with OCR), XLSX, CSV
                </p>
            </div>
            <div id="uploadProgress" style="display: none; margin-top: 1rem;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p id="uploadStatus" style="margin-top: 0.5rem; text-align: center;"></p>
            </div>
        </div>

        <div class="card">
            <h2>üìã Recent Ingestion Jobs</h2>
            <div class="file-list" id="jobList">
                <!-- Jobs will be populated here -->
            </div>
        </div>

        <div class="google-drive-section">
            <h2>üîó Google Drive Integration</h2>
            <div id="driveAuth" style="text-align: center; padding: 2rem;">
                <p style="margin-bottom: 1rem;">Connect your Google Drive to import files directly</p>
                <button class="btn" onclick="authenticateGoogleDrive()">Connect Google Drive</button>
            </div>
            <div id="driveConnected" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <p>‚úÖ Connected to Google Drive</p>
                    <button class="btn btn-secondary" onclick="browseDriveFiles()">Browse Files</button>
                </div>
                <div id="driveFiles" class="drive-files">
                    <!-- Drive files will be populated here -->
                </div>
                <div style="text-align: center; margin-top: 1rem;">
                    <button class="btn" onclick="ingestSelectedFiles()" id="ingestButton" disabled>
                        Ingest Selected Files
                    </button>
                </div>
            </div>
        </div>

        <div id="messageContainer"></div>
    </div>

    <script>
        const API_BASE = '/api/v1';
        let selectedDriveFiles = new Set();
        let authToken = localStorage.getItem('api_key') || 'demo-token';

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            setupDragAndDrop();
            setupFileInput();
            checkGoogleDriveAuth();
            loadRecentJobs();
            updateStats();
            setInterval(loadRecentJobs, 5000); // Refresh every 5 seconds
            setInterval(updateStats, 10000); // Update stats every 10 seconds
        });

        // Drag and drop setup
        function setupDragAndDrop() {
            const zone = document.getElementById('uploadZone');
            
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('drag-over');
            });
            
            zone.addEventListener('dragleave', () => {
                zone.classList.remove('drag-over');
            });
            
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('drag-over');
                handleFiles(e.dataTransfer.files);
            });
        }

        // File input setup
        function setupFileInput() {
            document.getElementById('fileInput').addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        // Handle file upload
        async function handleFiles(files) {
            if (files.length === 0) return;
            
            const uploadProgress = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            const uploadStatus = document.getElementById('uploadStatus');
            
            uploadProgress.style.display = 'block';
            progressFill.style.width = '0%';
            
            if (files.length === 1) {
                // Single file upload
                const formData = new FormData();
                formData.append('file', files[0]);
                formData.append('tags', 'dashboard-upload');
                
                uploadStatus.textContent = `Uploading ${files[0].name}...`;
                
                try {
                    const response = await fetch(`${API_BASE}/ingest/upload`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        showMessage('success', `File uploaded successfully! Job ID: ${result.job_id}`);
                        progressFill.style.width = '100%';
                        setTimeout(() => {
                            uploadProgress.style.display = 'none';
                            loadRecentJobs();
                        }, 2000);
                    } else {
                        throw new Error(`Upload failed: ${response.statusText}`);
                    }
                } catch (error) {
                    showMessage('error', `Upload failed: ${error.message}`);
                    uploadProgress.style.display = 'none';
                }
            } else {
                // Batch upload
                const formData = new FormData();
                for (let file of files) {
                    formData.append('files', file);
                }
                formData.append('request', JSON.stringify({
                    tags: ['dashboard-upload', 'batch'],
                    metadata: { upload_time: new Date().toISOString() }
                }));
                
                uploadStatus.textContent = `Uploading ${files.length} files...`;
                
                try {
                    const response = await fetch(`${API_BASE}/ingest/upload/batch`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        showMessage('success', `Batch upload successful! Job ID: ${result.job_id}`);
                        progressFill.style.width = '100%';
                        setTimeout(() => {
                            uploadProgress.style.display = 'none';
                            loadRecentJobs();
                        }, 2000);
                    } else {
                        throw new Error(`Upload failed: ${response.statusText}`);
                    }
                } catch (error) {
                    showMessage('error', `Batch upload failed: ${error.message}`);
                    uploadProgress.style.display = 'none';
                }
            }
        }

        // Load recent ingestion jobs
        async function loadRecentJobs() {
            try {
                const response = await fetch(`${API_BASE}/ingest/jobs`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const jobs = await response.json();
                    displayJobs(jobs);
                }
            } catch (error) {
                console.error('Failed to load jobs:', error);
            }
        }

        // Display jobs
        function displayJobs(jobs) {
            const jobList = document.getElementById('jobList');
            jobList.innerHTML = '';
            
            if (jobs.length === 0) {
                jobList.innerHTML = '<p style="text-align: center; color: #718096;">No recent jobs</p>';
                return;
            }
            
            jobs.slice(0, 10).forEach(job => {
                const jobItem = document.createElement('div');
                jobItem.className = 'file-item';
                
                const icon = getFileIcon(job.file_type);
                const statusBadge = getStatusBadge(job.status);
                
                jobItem.innerHTML = `
                    <div style="display: flex; align-items: center;">
                        <div class="file-icon ${icon.class}">${icon.icon}</div>
                        <div>
                            <div style="font-weight: 600;">${job.filename}</div>
                            <div style="font-size: 0.9rem; color: #718096;">
                                ${new Date(job.created_at).toLocaleString()}
                            </div>
                        </div>
                    </div>
                    <div>
                        ${statusBadge}
                        ${job.result && job.result.memories_created ? 
                            `<div style="font-size: 0.8rem; color: #a0aec0; margin-top: 0.25rem;">
                                ${job.result.memories_created} memories
                            </div>` : ''}
                    </div>
                `;
                
                jobList.appendChild(jobItem);
            });
        }

        // Get file icon based on type
        function getFileIcon(mimeType) {
            if (mimeType.includes('pdf')) return { icon: 'üìÑ', class: 'pdf-icon' };
            if (mimeType.includes('word') || mimeType.includes('document')) return { icon: 'üìù', class: 'doc-icon' };
            if (mimeType.includes('image')) return { icon: 'üñºÔ∏è', class: 'img-icon' };
            if (mimeType.includes('sheet') || mimeType.includes('csv')) return { icon: 'üìä', class: 'sheet-icon' };
            return { icon: 'üìÉ', class: 'txt-icon' };
        }

        // Get status badge
        function getStatusBadge(status) {
            const badges = {
                'pending': '<span class="status-badge status-pending">Pending</span>',
                'processing': '<span class="status-badge status-processing">Processing</span>',
                'completed': '<span class="status-badge status-completed">Completed</span>',
                'failed': '<span class="status-badge status-failed">Failed</span>'
            };
            return badges[status] || badges['pending'];
        }

        // Update statistics
        async function updateStats() {
            try {
                const response = await fetch(`${API_BASE}/ingest/jobs`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const jobs = await response.json();
                    
                    // Calculate stats
                    const totalProcessed = jobs.filter(j => j.status === 'completed').length;
                    const activeJobs = jobs.filter(j => j.status === 'processing').length;
                    const recentJobs = jobs.filter(j => {
                        const jobTime = new Date(j.created_at);
                        const dayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
                        return jobTime > dayAgo;
                    });
                    
                    const successRate = recentJobs.length > 0 
                        ? Math.round((recentJobs.filter(j => j.status === 'completed').length / recentJobs.length) * 100)
                        : 100;
                    
                    const memoriesCreated = jobs
                        .filter(j => j.status === 'completed' && j.result)
                        .reduce((sum, j) => sum + (j.result.memories_created || 0), 0);
                    
                    // Update UI
                    document.getElementById('totalProcessed').textContent = totalProcessed;
                    document.getElementById('activeJobs').textContent = activeJobs;
                    document.getElementById('successRate').textContent = `${successRate}%`;
                    document.getElementById('memoriesCreated').textContent = memoriesCreated;
                }
            } catch (error) {
                console.error('Failed to update stats:', error);
            }
        }

        // Google Drive authentication
        async function authenticateGoogleDrive() {
            try {
                const response = await fetch(`${API_BASE}/google-drive/auth/url`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    window.open(data.auth_url, '_blank');
                    showMessage('info', 'Complete authentication in the new window, then enter the code.');
                    
                    // Show auth code input
                    const code = prompt('Enter the authorization code from Google:');
                    if (code) {
                        await completeGoogleAuth(code);
                    }
                }
            } catch (error) {
                showMessage('error', `Authentication failed: ${error.message}`);
            }
        }

        // Complete Google authentication
        async function completeGoogleAuth(code) {
            try {
                const response = await fetch(`${API_BASE}/google-drive/auth/callback`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ auth_code: code })
                });
                
                if (response.ok) {
                    showMessage('success', 'Successfully connected to Google Drive!');
                    checkGoogleDriveAuth();
                } else {
                    throw new Error('Authentication failed');
                }
            } catch (error) {
                showMessage('error', `Authentication failed: ${error.message}`);
            }
        }

        // Check Google Drive auth status
        async function checkGoogleDriveAuth() {
            try {
                const response = await fetch(`${API_BASE}/google-drive/auth/status`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.authenticated) {
                        document.getElementById('driveAuth').style.display = 'none';
                        document.getElementById('driveConnected').style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Failed to check auth status:', error);
            }
        }

        // Browse Google Drive files
        async function browseDriveFiles() {
            try {
                const response = await fetch(`${API_BASE}/google-drive/files?page_size=20`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayDriveFiles(data.files);
                }
            } catch (error) {
                showMessage('error', `Failed to load files: ${error.message}`);
            }
        }

        // Display Google Drive files
        function displayDriveFiles(files) {
            const container = document.getElementById('driveFiles');
            container.innerHTML = '';
            
            if (files.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #718096;">No supported files found</p>';
                return;
            }
            
            files.forEach(file => {
                if (file.is_folder) return;
                
                const fileDiv = document.createElement('div');
                fileDiv.className = 'drive-file';
                fileDiv.dataset.fileId = file.id;
                
                const icon = getFileIcon(file.mime_type);
                
                fileDiv.innerHTML = `
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">${icon.icon}</div>
                    <div style="font-size: 0.9rem; font-weight: 500;">${file.name}</div>
                    <div style="font-size: 0.8rem; color: #718096; margin-top: 0.25rem;">
                        ${formatFileSize(file.size)}
                    </div>
                `;
                
                fileDiv.addEventListener('click', () => toggleFileSelection(fileDiv, file.id));
                
                container.appendChild(fileDiv);
            });
        }

        // Toggle file selection
        function toggleFileSelection(element, fileId) {
            element.classList.toggle('selected');
            
            if (selectedDriveFiles.has(fileId)) {
                selectedDriveFiles.delete(fileId);
            } else {
                selectedDriveFiles.add(fileId);
            }
            
            document.getElementById('ingestButton').disabled = selectedDriveFiles.size === 0;
        }

        // Ingest selected files
        async function ingestSelectedFiles() {
            if (selectedDriveFiles.size === 0) return;
            
            try {
                const response = await fetch(`${API_BASE}/google-drive/ingest`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        file_ids: Array.from(selectedDriveFiles),
                        tags: ['google-drive', 'dashboard-import'],
                        metadata: { import_time: new Date().toISOString() }
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showMessage('success', result.message);
                    selectedDriveFiles.clear();
                    document.querySelectorAll('.drive-file.selected').forEach(el => {
                        el.classList.remove('selected');
                    });
                    document.getElementById('ingestButton').disabled = true;
                    setTimeout(loadRecentJobs, 2000);
                } else {
                    throw new Error('Ingestion failed');
                }
            } catch (error) {
                showMessage('error', `Failed to ingest files: ${error.message}`);
            }
        }

        // Format file size
        function formatFileSize(bytes) {
            if (!bytes) return 'Unknown size';
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Show message
        function showMessage(type, message) {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.textContent = message;
            
            container.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>